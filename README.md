# PySurf-FSSH: New Plugin for PySurf to Perform Nonadiabatic Dynamics using FSSH

# <img src="https://raw.githubusercontent.com/gatox/pysurf_fssh/master/docs/logo_pysurf_fssh.jpeg">

#

[PySurf-FSSH](https://doi.org/10.1021/acs.jctc.4c00012) is an extension of the [PySurf](https://github.com/mfsjmenger/pysurf) software package that enables nonadiabatic molecular dynamics simulations using the Tully’s fewest switches surface hopping (FSSH) scheme or the Landau–Zener surface hopping (LZSH) method. It includes built-in interfaces with several quantum chemistry packages such as [Q-Chem](https://manual.q-chem.com/latest/), [OpenMolcas](https://gitlab.com/Molcas/OpenMolcas), [BAGEL](https://nubakery.org/), and the quantum algorithm State-Averaged Orbital-Optimized VQE ([SAOOVQE](https://github.com/qc2nl/SAOOVQE)). Thanks to PySurf’s flexible architecture, new interfaces can be added with minimal effort. As a demonstration, an analytical Linear Vibronic Coupling (LVC) model is also included, providing a fast and accessible way to test and extend PySurf-FSSH functionality.

---

# \:books: Purpose and Features

- Surface hopping dynamics via FSSH or LZSH
- Initial positions and velocities via Wigner distributions using the `molden` format
- Compatible with `molden` files generated by Q-Chem and OpenMolcas
- Ab initio on-the-fly dynamics supported via Q-Chem, OpenMolcas, etc.
- Model Hamiltonians supported (e.g., pyrazine LVC)
- Decoherence corrections (e.g., EDC)
- Velocity rescaling strategies (e.g., NACS-based)
- Thermostatting option for temperature control ([Nosé–Hoover](https://pubs.aip.org/aip/jcp/article/83/8/4069/219065/The-Nose-Hoover-thermostatThe-Nose-Hoover))
- NetCDF-based trajectory database (`results.db`)

---

# \:rocket: Installation

`pysurf_fssh` is a plugin for [PySurf](https://github.com/mfsjmenger/pysurf) that requires an external electronic structure package to compute the necessary electronic properties for dynamics (e.g., energies, gradients, nonadiabatic couplings). Supported backends include:

- Quantum chemistry software such as [Q-Chem](https://manual.q-chem.com/latest/), [OpenMolcas](https://gitlab.com/Molcas/OpenMolcas), and [BAGEL](https://nubakery.org/)
- Quantum simulation backends like [SAOOVQE](https://github.com/qc2nl/SAOOVQE)
- Model Hamiltonians such as an analytical LVC model (included as an example)

The following installation guide shows how to set up `pysurf_fssh` in combination with `SAOOVQE`, as an example backend. The installation order (first SAOOVQE, then PySurf-FSSH) is important for compatibility in this specific case.

### \:wrench: Example Setup: SAOOVQE + PySurf-FSSH

We recommend using a clean [Anaconda](https://www.anaconda.com/) environment. A pre-configured environment file is provided: `env_pysurf_saoovqe.yml`.

#### Quick Setup (YAML File)

```bash
conda env create -f env_pysurf_saoovqe.yml
conda activate pysurf_saoovqe
```

#### Manual Setup

1. **Create and activate a new environment**

    ```bash
    conda create -y -n pysurf_saoovqe python=3.9
    conda activate pysurf_saoovqe
    ```

2. **Install SAOOVQE and its dependencies**

    ```bash
    pip install numpy scipy numba openfermion cirq
    conda install -c psi4 psi4

    git clone https://github.com/qc2nl/SAOOVQE.git
    cd SAOOVQE
    pip install -e .
    cd ..
    ```

3. **Install PySurf-FSSH and its dependencies**

    ```bash
    git clone https://github.com/gatox/pysurf_fssh.git
    cd pysurf_fssh
    pip install pycolt qctools netcdf4 numpy matplotlib
    ```

4. **Set environment variables**

    Add the following lines to your shell config file (`~/.bashrc`, `~/.zshrc`, etc.):

    ```bash
    export PYTHONPATH=/full/path/to/pysurf_fssh:$PYTHONPATH
    export SAOOVQEDIR=/full/path/to/SAOOVQE
    ```

    Replace `/full/path/to/` with the actual absolute paths on your system.

5. **Recommended branches**

    For proper compatibility when using **PySurf-FSSH** with **SAOOVQE**, we recommend using the following branches:

    - **PySurf-FSSH**: use the `master` branch (default and recommended)  
      > Note: The older `vdf_old_branch` is still compatible, but the included examples are tailored to features available in the `master` branch.
    - **SAOOVQE**: use the `noise_old_saoovqe` branch (required)

    To switch branches:

    ```bash
    cd pysurf_fssh
    git checkout master
    
    cd ../SAOOVQE
    git checkout noise_old_saoovqe
    ```
---

If you are using another backend (like **OpenMolcas** or **Q-Chem**), install that backend according to its documentation. You can then configure `pysurf_fssh` to work with it by adapting the interface accordingly.

The flexibility of `pysurf_fssh` makes it easy to extend to additional electronic structure packages.

---

# \:sunrise: Examples

The `examples/` folder includes ready-to-run demonstrations:

## 1. CH2NH + SAOOVQE (Ab Initio)

Located in: `examples/ch2nh_saoovqe/`

Each subfolder (e.g., `ch2nh_t_noise_f_therm`) represents different combinations of noise and thermostat usage. Folder naming convention:

- `t` = true (used)
- `f` = false (not used)

For instance, `ch2nh_t_noise_f_therm` uses noise but no thermostat.

### Input setup:

- 10 trajectories generated with Wigner sampling (`sampling.inp`)
- Starting from the first excited state
- Time step: 10 a.u. (\~0.25 fs)
- Dynamics span 3 steps
- Noise: mean = 0, variance = 1.0e-8
- Electronic structure settings: `spp.inp`
- Dynamics control: `prop.inp`

### How to run:

```bash
cd ch2nh_t_noise_f_therm
python /full/path/to/pysurf_fssh/bin/sampling.py
python /full/path/to/pysurf_fssh/bin/setup_propagation.py

# run the trajectory No.7
cd prop/traj_00000007
python /full/path/to/pysurf_fssh/bin/run_trajectory.py
```
Replace `/full/path/to/` with the actual absolute paths on your system.
Results are saved in `results.db` and `gen_results.out`.

## 2. Pyrazine LVC Model

Located in: `examples/pyrazine_lvc_model/`

Two folders:

- `pyrazine_f_therm`: no thermostat
- `pyrazine_t_therm`: thermostat enabled

### Input setup:

- 10 trajectories generated with Wigner sampling (`sampling.inp`)
- Time step: 20 a.u. (\~0.5 fs)
- Total time: 417 steps (\~200 fs)
- Settings in `spp.inp`, `prop.inp`

### How to run:

```bash
cd pyrazine_lvc_model
python /full/path/to/pysurf_fssh/bin/sampling.py
python /full/path/to/pysurf_fssh/bin/setup_propagation.py

# run the trajectory No. 3
cd prop/traj_00000003
python /full/path/to/pysurf_fssh/bin/run_trajectory.py
```
Replace `/full/path/to/` with the actual absolute paths on your system.
This model runs extremely fast. To inspect results:

```bash
ncdump -v currstate results.db
cat gen_results.out
```

> Note: To change the number of trajectories, make sure to edit `sampling.inp` **before** running `sampling.py`. This will generate a new set of initial conditions. Likewise, the `spp.inp` and `prop.inp` files can be modified **before** running `setup_propagation.py`. If you have already run this setup and want to apply changes to **all** trajectories, you must delete the existing `prop` folder, update the input files, and rerun `setup_propagation.py`. If you prefer to change only specific trajectories, you can modify the input files individually within each trajectory folder without deleting the entire `prop` directory.
---

# \:card_index: Credits

This work was supported by the Innovational Research Incentives Scheme Vidi 2017 with project number **016.Vidi.189.044**, (partly) funded by the **Dutch Research Council (NWO)**.

This package was created with [Cookiecutter](https://github.com/audreyr/cookiecutter) and the [`audreyr/cookiecutter-pypackage`](https://github.com/audreyr/cookiecutter-pypackage) project template.
