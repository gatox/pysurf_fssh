# PySurf-FSSH: New Plugin for PySurf to Perform Nonadiabatic Dynamics using FSSH

# <img src="https://raw.githubusercontent.com/gatox/pysurf_fssh/master/docs/logo_pysurf_fssh.jpeg">

#

[PySurf-FSSH](https://doi.org/10.1021/acs.jctc.4c00012) is an extension of the [PySurf](https://github.com/mfsjmenger/pysurf) software package that enables nonadiabatic molecular dynamics simulations using the Tully’s fewest switches surface hopping (FSSH) scheme or the Landau–Zener surface hopping (LZSH) method. It includes built-in interfaces with several quantum chemistry packages such as [Q-Chem](https://manual.q-chem.com/latest/), [OpenMolcas](https://gitlab.com/Molcas/OpenMolcas), [BAGEL](https://nubakery.org/), and the quantum algorithm State-Averaged Orbital-Optimized VQE ([SAOOVQE](https://github.com/qc2nl/SAOOVQE)). Thanks to PySurf’s flexible architecture, new interfaces can be added with minimal effort. As a demonstration, an analytical Linear Vibronic Coupling (LVC) model is also included, providing a fast and accessible way to test and extend PySurf-FSSH functionality.

---

# \:books: Purpose and Features

- Surface hopping dynamics via FSSH or LZSH
- Initial positions and velocities via Wigner distributions using the `molden` format
- Compatible with `molden` files generated by Q-Chem and OpenMolcas
- Ab initio on-the-fly dynamics supported via Q-Chem, OpenMolcas, etc.
- Model Hamiltonians supported (e.g., pyrazine LVC)
- Decoherence corrections (e.g., EDC)
- Velocity rescaling strategies (e.g., NACS-based)
- Thermostatting option for temperature control ([Nosé–Hoover](https://pubs.aip.org/aip/jcp/article/83/8/4069/219065/The-Nose-Hoover-thermostatThe-Nose-Hoover))
- NetCDF-based trajectory database (`results.db`)

---

# \:rocket: Installation

`pysurf_fssh` is a plugin for [PySurf](https://github.com/mfsjmenger/pysurf) that requires an external electronic structure package to compute the necessary electronic properties for dynamics (e.g., energies, gradients, nonadiabatic couplings). The following quantum chemistry packages are supported:

- Quantum chemistry software such as [Q-Chem](https://manual.q-chem.com/latest/), [OpenMolcas](https://gitlab.com/Molcas/OpenMolcas), and [BAGEL](https://nubakery.org/)
- Quantum algorithms such as [SAOOVQE](https://github.com/qc2nl/SAOOVQE)
- Model Hamiltonians such as an analytical LVC model (included as an example)

### \:wrench: Setup PySurf-FSSH

We recommend using a clean [Anaconda](https://www.anaconda.com/) environment. A pre-configured environment file is provided: `env_pysurf_fssh.yml`.

#### Quick Setup (YAML File)

```bash
conda env create -f env_pysurf_fssh.yml
conda activate pysurf_fssh
```

#### Manual Setup

1. **Create and activate a new environment**

    ```bash
    conda create -y -n pysurf_fssh python=3.9
    conda activate pysurf_fssh
    ```

2. **Install PySurf-FSSH and its dependencies**

    ```bash
    git clone https://github.com/gatox/pysurf_fssh.git
    cd pysurf_fssh

    # pysurf_fssh dependencies
    conda install -c conda-forge numpy scipy matplotlib h5py netcdf4
    pip install pycolt qctools jinja2
    ```

3. **Set environment variables**

    Add the following line to your shell config file (`~/.bashrc`, `~/.zshrc`, etc.):

    ```bash
    export PYTHONPATH=/full/path/to/pysurf_fssh:$PYTHONPATH
    ```

    Replace `/full/path/to/` with the actual absolute paths on your system.

---

# :sunrise: Examples

The `examples/` folder includes ready-to-run demonstrations:

## 1. Pyrazine LVC Model

Located in: `examples/pyrazine_lvc_model/`

This model does not require any external quantum chemistry code and is included with `pysurf_fssh`. It provides a quick way to verify that your installation works and to test all the functionalities.

The `pyrazine_lvc_model` folder contains two subfolders:

- `pyrazine_f_therm`: no thermostat
- `pyrazine_t_therm`: thermostat enabled

### Input setup:

- 10 trajectories generated with Wigner sampling (`sampling.inp`)
- Time step: 20 a.u. (~0.5 fs)
- Total time: 417 steps (~200 fs)
- Settings in `spp.inp`, `prop.inp`

### How to run:

```bash
cd pyrazine_f_therm
python /full/path/to/pysurf_fssh/bin/sampling.py
python /full/path/to/pysurf_fssh/bin/setup_propagation.py

# run the trajectory No. 3
cd prop/traj_00000003
python /full/path/to/pysurf_fssh/bin/run_trajectory.py
```

Replace `/full/path/to/` with the actual absolute paths on your system.

To inspect results:

```bash
ncdump -v currstate results.db
cat gen_results.out
```

---

## 2. CH₂NH + SAOOVQE (Ab Initio)

Located in: `examples/ch2nh_saoovqe/`

> :warning: **Note:** This example requires access to the private [SAOOVQE](https://github.com/qc2nl/SAOOVQE) repository. Please make sure it is installed and working before attempting this example.
> For proper compatibility when using **PySurf-FSSH** with **SAOOVQE**, we recommend using the following branches:
>   - **PySurf-FSSH**: use the `master` branch (default and recommended)
>   - **SAOOVQE**: use the `noise_old_saoovqe` branch (required)
>
>    To switch branches:
>
>    ```bash
>    cd pysurf_fssh
>    git checkout master
>    
>    cd ../SAOOVQE
>    git checkout noise_old_saoovqe
>    ```

If you **do not** have access to SAOOVQE, you can still test `pysurf_fssh` functionality using the **Pyrazine LVC model** described above.

### Setup Instructions

1. **Install SAOOVQE** following its official instructions.
2. Then install `pysurf_fssh` as described in the installation section.
3. Enable the SAOOVQE interface by editing `core_plugins/plugins.ini`:

```ini
# To enable the SAOOVQE interface, make sure the following line is commented:
# interfaces/saoovqe_i.py
```
> :warning: **Note:** Although it may seem counterintuitive, the SAOOVQE interface is enabled when this line is commented (i.e., prefixed with #).

4. Add the following line to your shell configuration file (`~/.bashrc`, `~/.zshrc`, etc.):

```bash
export SAOOVQEDIR=/full/path/to/SAOOVQE
```

Replace `/full/path/to/SAOOVQE` with the actual path to your SAOOVQE installation.

---

Each subfolder inside `ch2nh_saoovqe` (e.g., `ch2nh_t_noise_f_therm`) represents a different configuration:

- `t` = true (enabled)
- `f` = false (disabled)

For example, `ch2nh_t_noise_f_therm` uses noise but no thermostat.

### Input setup:

- 10 trajectories using Wigner sampling (`sampling.inp`)
- Initial state: first excited state
- Time step: 10 a.u. (~0.25 fs)
- Simulation length: 3 steps
- Noise parameters: mean = 0, variance = 1.0e-8
- Settings: `spp.inp`, `prop.inp`

### How to run:

```bash
cd ch2nh_t_noise_f_therm
python /full/path/to/pysurf_fssh/bin/sampling.py
python /full/path/to/pysurf_fssh/bin/setup_propagation.py

# Run trajectory No. 7
cd prop/traj_00000007
python /full/path/to/pysurf_fssh/bin/run_trajectory.py
```

Results will be stored in `results.db` and `gen_results.out`.

> :information_source: **Tip:** To change the number of trajectories or other parameters, update `sampling.inp`, `spp.inp`, or `prop.inp` **before** running the setup scripts.  
To apply changes across all trajectories, delete the `prop/` folder and rerun `setup_propagation.py`.  
To modify specific trajectories only, edit their individual folders directly.

---

# \:card_index: Credits

This work was supported by the Innovational Research Incentives Scheme Vidi 2017 with project number **016.Vidi.189.044**, (partly) funded by the **Dutch Research Council (NWO)**.

This package was created with [Cookiecutter](https://github.com/audreyr/cookiecutter) and the [`audreyr/cookiecutter-pypackage`](https://github.com/audreyr/cookiecutter-pypackage) project template.
